<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>note タイピングゲーム</title>

<!-- kuromoji -->
<script src="https://unpkg.com/kuromoji@0.1.2/dist/kuromoji.js"></script>

<!-- wanakana（確実に動くCDN） -->
<script src="https://unpkg.com/wanakana@5.3.1/wanakana.min.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 20px;
  line-height: 1.8;
}

#jp span.done {
  color: #4caf50;
}

#jp span.todo {
  color: #000;
}

#romaji {
  margin-top: 10px;
  font-size: 14px;
  color: #666;
}

#status {
  margin-top: 10px;
}
</style>
</head>
<body>

<h2>note タイピングゲーム</h2>

<div id="jp"></div>
<div id="romaji"></div>
<div id="status">読み込み中…</div>

<script>
/*
  ============================
  設定
  ============================
*/

// note info RSS（ユーザー名を info にする）
const RSS_URL =
  "https://api.rss2json.com/v1/api.json?rss_url=https://note.com/info/rss";

// kuromoji 辞書パス（GitHub Pages 用）
const DICT_PATH = "dict";

/*
  ============================
  状態管理
  ============================
*/

let sentences = [];     // 出題文配列
let currentSentence = "";
let kana = "";
let romaji = "";
let input = "";
let index = 0;

/*
  ============================
  初期処理
  ============================
*/

fetch(RSS_URL)
  .then(res => res.json())
  .then(data => {
    // 本文をまとめて取得
    const text = data.items
      .map(item => item.content)
      .join("\n")
      .replace(/<[^>]+>/g, "")   // HTML除去
      .replace(/[a-zA-Z0-9]/g, ""); // 英数字除去

    // 改行 ＋ 句点で分割
    sentences = text
      .split(/[\n。]/)
      .map(s => s.trim())
      .filter(s => s.length > 0)
      .map(s => s + "。"); // 表示用に句点を戻す

    initKuromoji();
  });

function initKuromoji() {
  kuromoji.builder({ dicPath: DICT_PATH }).build((err, tokenizer) => {
    if (err) {
      document.getElementById("status").textContent = "辞書読み込み失敗";
      return;
    }
    window.tokenizer = tokenizer;
    nextSentence();
  });
}

/*
  ============================
  1文出題
  ============================
*/

function nextSentence() {
  index = 0;
  input = "";
  currentSentence = sentences.shift();
  if (!currentSentence) {
    document.getElementById("status").textContent = "終了！";
    return;
  }

  // 形態素解析 → 読み取得
  const tokens = tokenizer.tokenize(currentSentence);
  kana = tokens.map(t => t.reading || t.surface_form).join("");
  romaji = wanakana.toRomaji(kana);

  render();
  document.getElementById("status").textContent = "入力してください";
}

/*
  ============================
  表示
  ============================
*/

function render() {
  const jpDiv = document.getElementById("jp");
  jpDiv.innerHTML = "";

  for (let i = 0; i < currentSentence.length; i++) {
    const span = document.createElement("span");
    span.textContent = currentSentence[i];
    span.className = i < index ? "done" : "todo";
    jpDiv.appendChild(span);
  }

  document.getElementById("romaji").textContent =
    romaji.slice(input.length);
}

/*
  ============================
  キー入力
  ============================
*/

document.addEventListener("keydown", e => {
  if (!romaji) return;

  const key = e.key.toLowerCase();
  if (romaji[input.length] === key) {
    input += key;

    // 日本語文字位置更新（ざっくり対応）
    if (input.length >= wanakana.toRomaji(
        wanakana.toHiragana(
          currentSentence.slice(0, index + 1)
        )
      ).length) {
      index++;
    }

    if (input === romaji) {
      nextSentence();
      return;
    }

    render();
  }
});
</script>

</body>
</html>
