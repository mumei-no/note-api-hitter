<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>note タイピング</title>

<!-- kuromoji：ローカル -->
<script src="./kuromoji.js"></script>

<!-- wanakana：CDN -->
<script src="https://unpkg.com/wanakana@5.3.1/wanakana.min.js"></script>

<style>
body { font-family: sans-serif; padding: 20px; }
.done { color: #4caf50; }
.todo { color: #000; }
</style>
</head>
<body>

<h3>note タイピング</h3>
<div id="jp"></div>
<div id="romaji"></div>
<div id="status">読み込み中…</div>

<script>
const RSS_URL =
  "https://api.rss2json.com/v1/api.json?rss_url=https://note.com/info/rss";
const DICT_PATH = "dict";

let sentence = "";
let kana = "";
let romaji = "";
let input = "";
let index = 0;

// RSS取得
fetch(RSS_URL)
  .then(r => r.json())
  .then(data => {
    sentence = data.items[0].content
      .replace(/<[^>]+>/g, "")
      .replace(/[a-zA-Z0-9]/g, "")
      .split(/[\n。]/)
      .filter(s => s)[0] + "。";

    initKuromoji();
  });

function initKuromoji() {
  kuromoji.builder({ dicPath: DICT_PATH }).build((err, tokenizer) => {
    if (err) {
      document.getElementById("status").textContent = "辞書エラー";
      console.error(err);
      return;
    }

    const tokens = tokenizer.tokenize(sentence);
    kana = tokens.map(t => t.reading || t.surface_form).join("");
    romaji = wanakana.toRomaji(kana);

    render();
    document.getElementById("status").textContent = "入力してください";
  });
}

function render() {
  const jp = document.getElementById("jp");
  jp.innerHTML = "";
  for (let i = 0; i < sentence.length; i++) {
    const span = document.createElement("span");
    span.textContent = sentence[i];
    span.className = i < index ? "done" : "todo";
    jp.appendChild(span);
  }
  document.getElementById("romaji").textContent =
    romaji.slice(input.length);
}

document.addEventListener("keydown", e => {
  const k = e.key.toLowerCase();
  if (romaji[input.length] === k) {
    input += k;
    index++;
    render();
  }
});
</script>

</body>
</html>
