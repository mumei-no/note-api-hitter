<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Japanese Typing Game</title>

<style>
body {
  font-family: system-ui, sans-serif;
  padding: 20px;
}
#jp {
  font-size: 24px;
  margin-bottom: 10px;
}
#roma {
  color: #666;
  margin-bottom: 10px;
}
#input {
  font-size: 20px;
}
#status {
  margin-top: 10px;
}
</style>
</head>
<body>

<h1>æ—¥æœ¬èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h1>

<div id="jp">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
<div id="roma"></div>

<input id="input" autocomplete="off" />
<div id="status"></div>

<script src="./kuromoji.js"></script>
<script>
/* =============================
   1. ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä»®ï¼‰
   ============================= */
const text = "ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ã€‚";

/* =============================
   2. ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
   ============================= */
function kataToHira(str) {
  return str.replace(/[\u30a1-\u30f6]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0) - 0x60)
  );
}

/* =============================
   3. ã²ã‚‰ãŒãªâ†’ãƒ­ãƒ¼ãƒå­—ï¼ˆæœ€å°ï¼‰
   ============================= */
const romaTable = {
  ã‚:"a", ã„:"i", ã†:"u", ãˆ:"e", ãŠ:"o",
  ã‹:"ka", ã:"ki", ã:"ku", ã‘:"ke", ã“:"ko",
  ã•:"sa", ã—:"shi", ã™:"su", ã›:"se", ã:"so",
  ãŸ:"ta", ã¡:"chi", ã¤:"tsu", ã¦:"te", ã¨:"to",
  ãª:"na", ã«:"ni", ã¬:"nu", ã­:"ne", ã®:"no",
  ã¯:"ha", ã²:"hi", ãµ:"fu", ã¸:"he", ã»:"ho",
  ã¾:"ma", ã¿:"mi", ã‚€:"mu", ã‚:"me", ã‚‚:"mo",
  ã‚„:"ya", ã‚†:"yu", ã‚ˆ:"yo",
  ã‚‰:"ra", ã‚Š:"ri", ã‚‹:"ru", ã‚Œ:"re", ã‚:"ro",
  ã‚:"wa", ã‚’:"o", ã‚“:"n",
  ãƒ¼:"-", "ã€‚":".", "ã€":","
};

function hiraToRoma(str) {
  return [...str].map(c => romaTable[c] ?? c).join("");
}

/* =============================
   4. kuromoji åˆæœŸåŒ–
   ============================= */
kuromoji.builder({ dicPath: "./dict" }).build((err, tokenizer) => {
  if (err) {
    document.getElementById("jp").textContent = "è¾æ›¸èª­ã¿è¾¼ã¿å¤±æ•—";
    console.error(err);
    return;
  }

  // å½¢æ…‹ç´ è§£æ
  const tokens = tokenizer.tokenize(text);

  // èª­ã¿ã‚’é€£çµ
  const reading = tokens
    .map(t => t.reading || t.surface_form)
    .join("");

  const hira = kataToHira(reading);
  const roma = hiraToRoma(hira);

  startGame(text, roma);
});

/* =============================
   5. ã‚²ãƒ¼ãƒ æœ¬ä½“
   ============================= */
function startGame(jpText, romaText) {
  const jp = document.getElementById("jp");
  const roma = document.getElementById("roma");
  const input = document.getElementById("input");
  const status = document.getElementById("status");

  let index = 0;

  jp.textContent = jpText;
  roma.textContent = romaText;

  input.focus();

  input.addEventListener("input", () => {
    const val = input.value;

    if (romaText.startsWith(val)) {
      status.textContent = "OK";
      if (val === romaText) {
        status.textContent = "ğŸ‰ ã‚¯ãƒªã‚¢ï¼";
        input.disabled = true;
      }
    } else {
      status.textContent = "âŒ ãƒŸã‚¹";
    }
  });
}
</script>

</body>
</html>
